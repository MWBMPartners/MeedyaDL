# Temporary diagnostic workflow — delete after verifying RELEASE_PAT permissions.
# Run via: gh workflow run "Check PAT" --ref main

name: Check PAT

on:
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Test RELEASE_PAT permissions
        env:
          PAT: ${{ secrets.RELEASE_PAT }}
        run: |
          echo "### RELEASE_PAT Diagnostic" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ -z "$PAT" ]; then
            echo "❌ **RELEASE_PAT is empty or not set**" >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi
          echo "✅ Secret is set (non-empty)" >> "$GITHUB_STEP_SUMMARY"

          # Call the API and capture headers + body
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: Bearer $PAT" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -D /tmp/headers.txt \
            "https://api.github.com/repos/${{ github.repository }}")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**API Response:** HTTP $HTTP_CODE" >> "$GITHUB_STEP_SUMMARY"

          # Classic PAT: X-OAuth-Scopes header lists granted scopes
          SCOPES=$(grep -i "x-oauth-scopes:" /tmp/headers.txt | cut -d: -f2- | xargs)
          if [ -n "$SCOPES" ]; then
            echo "**Token type:** Classic PAT" >> "$GITHUB_STEP_SUMMARY"
            echo "**Scopes:** \`$SCOPES\`" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            if echo "$SCOPES" | grep -q "repo"; then
              echo "✅ Has \`repo\` scope (full access)" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "❌ Missing \`repo\` scope — release-please needs this to create tags and releases" >> "$GITHUB_STEP_SUMMARY"
              if echo "$SCOPES" | grep -q "public_repo"; then
                echo "⚠️  Has \`public_repo\` but may need full \`repo\` for release creation" >> "$GITHUB_STEP_SUMMARY"
              fi
            fi
          else
            echo "**Token type:** Fine-grained PAT (no X-OAuth-Scopes header)" >> "$GITHUB_STEP_SUMMARY"
          fi

          # Check repo permissions returned in the response
          PERMS=$(echo "$RESPONSE" | head -n -1 | jq -r '.permissions // empty' 2>/dev/null)
          if [ -n "$PERMS" ] && [ "$PERMS" != "null" ]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "**Repository permissions:**" >> "$GITHUB_STEP_SUMMARY"
            echo '```json' >> "$GITHUB_STEP_SUMMARY"
            echo "$RESPONSE" | head -n -1 | jq '.permissions' >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"

            PUSH=$(echo "$RESPONSE" | head -n -1 | jq -r '.permissions.push // false')
            ADMIN=$(echo "$RESPONSE" | head -n -1 | jq -r '.permissions.admin // false')
            if [ "$PUSH" = "true" ]; then
              echo "✅ Has **push** permission (can create tags)" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "❌ Missing **push** permission — cannot create tags" >> "$GITHUB_STEP_SUMMARY"
            fi
            if [ "$ADMIN" = "true" ]; then
              echo "✅ Has **admin** permission" >> "$GITHUB_STEP_SUMMARY"
            fi
          fi

          # Test release creation permission specifically
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Testing release creation endpoint...**" >> "$GITHUB_STEP_SUMMARY"
          RELEASE_TEST=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST \
            -H "Authorization: Bearer $PAT" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -d '{"tag_name":"v0.0.0-test-delete-me","name":"DELETE ME","draft":true}' \
            "https://api.github.com/repos/${{ github.repository }}/releases")

          if [ "$RELEASE_TEST" = "201" ]; then
            echo "✅ Can create releases (HTTP 201)" >> "$GITHUB_STEP_SUMMARY"
            # Clean up the test release
            RELEASE_ID=$(curl -s \
              -H "Authorization: Bearer $PAT" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${{ github.repository }}/releases/tags/v0.0.0-test-delete-me" | jq -r '.id')
            curl -s -X DELETE \
              -H "Authorization: Bearer $PAT" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID"
            # Delete the test tag
            curl -s -X DELETE \
              -H "Authorization: Bearer $PAT" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${{ github.repository }}/git/refs/tags/v0.0.0-test-delete-me"
            echo "✅ Test release cleaned up" >> "$GITHUB_STEP_SUMMARY"
          elif [ "$RELEASE_TEST" = "404" ]; then
            echo "❌ **Cannot create releases (HTTP 404)** — this is the exact error release-please hits" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "**Fix:** Regenerate the PAT with \`Contents: Read and Write\` permission (fine-grained) or \`repo\` scope (classic)" >> "$GITHUB_STEP_SUMMARY"
          elif [ "$RELEASE_TEST" = "403" ]; then
            echo "❌ **Forbidden (HTTP 403)** — token lacks permission to create releases" >> "$GITHUB_STEP_SUMMARY"
          elif [ "$RELEASE_TEST" = "422" ]; then
            echo "⚠️  HTTP 422 (validation error) — token CAN reach the endpoint but request was invalid" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "⚠️  Unexpected HTTP $RELEASE_TEST" >> "$GITHUB_STEP_SUMMARY"
          fi
