# Copyright (c) 2024-2026 MWBM Partners Ltd
# Licensed under the MIT License. See LICENSE file in the project root.
#
# Release build workflow for gamdl-GUI.
# Triggered when a version tag (v*) is pushed. Builds platform-specific
# installers for macOS (DMG), Windows (MSI/NSIS), and Linux (DEB/AppImage),
# then publishes them as a draft GitHub Release.
#
# Tag format: v0.1.0, v1.0.0-beta.1, etc.
# The version number is extracted from the tag and used in the release.

name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  # ============================================================
  # Build and publish release for all platforms
  # ============================================================
  publish:
    name: Build (${{ matrix.settings.name }})
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        settings:
          # macOS Apple Silicon (ARM64) - MANDATORY
          - name: macOS (Apple Silicon)
            os: macos-latest
            args: '--target aarch64-apple-darwin'
            rust_target: aarch64-apple-darwin

          # Windows x64 - MANDATORY
          - name: Windows (x64)
            os: windows-latest
            args: '--target x86_64-pc-windows-msvc'
            rust_target: x86_64-pc-windows-msvc

          # Linux x64
          - name: Linux (x64)
            os: ubuntu-latest
            args: ''
            rust_target: ''

    runs-on: ${{ matrix.settings.os }}

    steps:
      # Step 1: Check out the repository code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up Node.js LTS with npm cache
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      # Step 3: Set up Rust stable toolchain
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.settings.rust_target }}

      # Step 4: Cache Rust compilation artifacts
      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      # Step 5: Install Linux system dependencies for Tauri
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libssl-dev \
            libgtk-3-dev

      # Step 6: Install npm dependencies
      - name: Install npm dependencies
        run: npm ci

      # Step 7: Build the application and create release bundles
      # Uses the official Tauri GitHub Action which handles:
      # - Building the frontend (npm run build)
      # - Building the Rust backend (cargo build --release)
      # - Packaging into platform-specific installers
      # - Uploading to GitHub Release
      - name: Build and publish
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'GAMDL GUI ${{ github.ref_name }}'
          releaseBody: |
            ## GAMDL GUI ${{ github.ref_name }}

            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details.

            ### Downloads
            | Platform | File |
            |----------|------|
            | macOS (Apple Silicon) | `.dmg` |
            | Windows (x64) | `.msi` / `.exe` |
            | Linux (x64) | `.deb` / `.AppImage` |

            ### First-Time Users
            On first launch, the app will download Python and GAMDL automatically.
            You will also need Apple Music cookies exported from your browser.
          releaseDraft: true
          prerelease: false
          args: ${{ matrix.settings.args }}
