# Copyright (c) 2024-2026 MeedyaDL
# Licensed under the MIT License. See LICENSE file in the project root.
#
# Release Build Workflow for MeedyaDL
# ======================================
#
# This GitHub Actions workflow builds platform-specific installers and publishes
# them as a draft GitHub Release. It is triggered when a version tag is pushed.
#
# Trigger: Push a tag matching 'v*' (e.g., git tag v0.1.0 && git push --tags)
#   - Semver tags:    v0.1.0, v1.0.0, v2.3.4
#   - Pre-release:    v1.0.0-alpha.1, v1.0.0-beta.2, v1.0.0-rc.1
#
# Build matrix (7 platform builds run in parallel):
#   Tier 1 — Stable (native or straightforward cross-compilation):
#     1. macOS Apple Silicon (aarch64-apple-darwin)
#        --> Produces: .dmg (disk image), .app (app bundle)
#     2. Windows x64 (x86_64-pc-windows-msvc)
#        --> Produces: .exe (NSIS installer)
#     3. Windows ARM64 (aarch64-pc-windows-msvc) — cross-compiled from x64
#        --> Produces: .exe (NSIS installer)
#     4. Linux x64 (native architecture)
#        --> Produces: .deb (Debian package), .AppImage (portable)
#
#   Note: Windows x86 (32-bit) is no longer built because Windows 11 is 64-bit
#   only and Windows 10 32-bit usage is under 1%. The x64 installer also works
#   on ARM64 devices via Windows' built-in x64 emulation layer, so ARM64 users
#   who prefer the emulated version can use the x64 installer directly.
#   WiX .msi installers are not produced because NSIS .exe is more capable,
#   is the only format that supports ARM64, and reduces artifact clutter.
#
#   Tier 2 — Experimental (Linux ARM cross-compilation):
#     6. Linux ARM64 (aarch64-unknown-linux-gnu) — for ARM servers and Pi 4/5 (64-bit)
#        --> Produces: .deb
#     7. Linux ARMv7 (armv7-unknown-linux-gnueabihf) — for Raspberry Pi (32-bit)
#        --> Produces: .deb
#
# The tauri-apps/tauri-action handles the entire build and upload pipeline:
#   1. Builds the frontend (npm run build --> vite build)
#   2. Compiles the Rust backend in release mode (cargo build --release --target ...)
#   3. Packages the binary into platform-specific installers
#   4. Creates a GitHub Release (or updates an existing draft) and uploads the artifacts
#
# The release is created as a DRAFT so maintainers can review release notes
# and artifacts before making it public.
#
# Related config files:
#   - src-tauri/tauri.conf.json -- Bundle configuration (icon, copyright, description, platform settings)
#   - src-tauri/Cargo.toml      -- Rust dependencies and package metadata
#   - cliff.toml                -- Changelog config (referenced in release notes)
#   - .github/workflows/changelog.yml -- Keeps CHANGELOG.md up to date
#   - .github/workflows/version-bump.yml -- Automated version bump that triggers this workflow
#
# @see https://docs.github.com/en/actions -- GitHub Actions documentation
# @see https://github.com/tauri-apps/tauri-action -- Tauri GitHub Action (handles build + release upload)
# @see https://v2.tauri.app/distribute/ -- Tauri distribution guide

# Workflow display name in the GitHub Actions UI
name: Release

# ============================================================
# Trigger: Run only when a version tag is pushed
# ============================================================
# The 'v*' pattern matches tags like v0.1.0, v1.0.0-beta.1, etc.
# This workflow does NOT run on regular pushes or pull requests.
# @see https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#push
on:
  push:
    tags:
      - 'v*'
  # Allow manual trigger for re-running builds when tag push events are missed
  # (e.g., after billing blocks or tag re-pushes). Usage:
  #   gh workflow run "Release" -f tag=v0.3.1
  workflow_dispatch:
    inputs:
      tag:
        description: 'Git tag to build and release (e.g., v0.3.1)'
        required: true

jobs:
  # ============================================================
  # Build and Publish Release Installers
  # ============================================================
  publish:
    name: Build (${{ matrix.settings.name }})

    # permissions: contents: write is required for the tauri-action to:
    #   - Create the GitHub Release
    #   - Upload release assets (installers)
    # This uses the automatic GITHUB_TOKEN, no PAT needed.
    # @see https://docs.github.com/en/actions/security-guides/automatic-token-authentication
    permissions:
      contents: write

    strategy:
      # fail-fast: false -- Build all platforms even if one fails.
      # A macOS build failure shouldn't prevent the Windows and Linux builds
      # from completing (they might succeed and be usable).
      fail-fast: false

      # Matrix defines the platform-specific build configurations.
      # Each entry produces a separate parallel job.
      matrix:
        settings:
          # ==========================================================
          # Tier 1: Stable targets (native or MSVC cross-compilation)
          # ==========================================================

          # macOS Apple Silicon (ARM64)
          # aarch64-apple-darwin targets Apple M1/M2/M3/M4 chips.
          # macos-latest runners are ARM64 by default.
          # Produces: MeedyaDL_x.x.x_aarch64.dmg and MeedyaDL.app
          - name: macOS (Apple Silicon)
            os: macos-latest
            args: '--target aarch64-apple-darwin'
            rust_target: aarch64-apple-darwin

          # Windows x64 (64-bit)
          # x86_64-pc-windows-msvc targets 64-bit Windows with MSVC toolchain.
          # --bundles nsis: Only build NSIS installer (skip WiX .msi).
          # Also works on ARM64 Windows via the built-in x64 emulation layer.
          # Produces: MeedyaDL_x.x.x_x64-setup.exe (NSIS)
          - name: Windows (x64)
            os: windows-latest
            args: '--target x86_64-pc-windows-msvc --bundles nsis'
            rust_target: x86_64-pc-windows-msvc

          # Windows ARM64 — cross-compiled from x64 runner
          # aarch64-pc-windows-msvc targets ARM64 Windows (Snapdragon X laptops,
          # Surface Pro X, etc.). MSVC provides ARM64 cross-compilation toolchain.
          # --bundles nsis: Only build NSIS installer (skip WiX .msi).
          # Produces: MeedyaDL_x.x.x_arm64-setup.exe (NSIS)
          - name: Windows (ARM64)
            os: windows-latest
            args: '--target aarch64-pc-windows-msvc --bundles nsis'
            rust_target: aarch64-pc-windows-msvc

          # Linux x64 (64-bit)
          # Uses the default target triple for ubuntu-latest (x86_64-unknown-linux-gnu).
          # Empty args/rust_target means "build for the host architecture".
          # Produces: gamdl_x.x.x_amd64.deb and gamdl_x.x.x_amd64.AppImage
          - name: Linux (x64)
            os: ubuntu-latest
            args: ''
            rust_target: ''

          # ==========================================================
          # Tier 2: Experimental targets (Linux ARM cross-compilation)
          # ==========================================================
          # These targets use multi-arch apt to install ARM system libraries
          # and a cross-compilation toolchain. They are marked as experimental
          # because ARM webkit2gtk packages may have availability issues.

          # Linux ARM64 — for ARM servers, Raspberry Pi 4/5 (64-bit OS)
          # Cross-compiled from x64 ubuntu-latest using gcc-aarch64-linux-gnu.
          # --bundles deb rpm: Skip AppImage because linuxdeploy's ARM64 binary
          # can't execute on x86_64 runners (Exec format error).
          # Produces: MeedyaDL_x.x.x_arm64.deb, MeedyaDL-x.x.x-1.aarch64.rpm
          - name: Linux (ARM64)
            os: ubuntu-latest
            args: '--target aarch64-unknown-linux-gnu --bundles deb rpm'
            rust_target: aarch64-unknown-linux-gnu
            cross_arch: arm64
            cross_gcc: gcc-aarch64-linux-gnu
            cross_linker: aarch64-linux-gnu-gcc
            cross_pkg_config_prefix: aarch64-linux-gnu

          # Linux ARMv7 — for Raspberry Pi (32-bit Raspberry Pi OS)
          # Cross-compiled from x64 ubuntu-latest using gcc-arm-linux-gnueabihf.
          # --bundles deb rpm: Skip AppImage (same reason as ARM64 above).
          # Produces: MeedyaDL_x.x.x_armhf.deb, MeedyaDL-x.x.x-1.armv7hl.rpm
          - name: Linux (ARMv7)
            os: ubuntu-latest
            args: '--target armv7-unknown-linux-gnueabihf --bundles deb rpm'
            rust_target: armv7-unknown-linux-gnueabihf
            cross_arch: armhf
            cross_gcc: gcc-arm-linux-gnueabihf
            cross_linker: arm-linux-gnueabihf-gcc
            cross_pkg_config_prefix: arm-linux-gnueabihf

    runs-on: ${{ matrix.settings.os }}

    # Linux ARM builds are experimental — allow them to fail without
    # blocking the overall release. All Tier 1 builds must succeed.
    continue-on-error: ${{ matrix.settings.cross_arch != '' }}

    steps:
      # Step 0: Resolve the release tag.
      # For tag pushes: github.ref_name is the tag (e.g., v0.3.1).
      # For workflow_dispatch: the tag is provided as an input.
      - name: Resolve release tag
        id: tag
        shell: bash
        run: |
          if [ -n "${{ inputs.tag }}" ]; then
            echo "name=${{ inputs.tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "name=${{ github.ref_name }}" >> "$GITHUB_OUTPUT"
          fi

      # Step 1: Check out the repository code at the tagged commit.
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.tag.outputs.name }}

      # Step 2: Set up Node.js LTS with npm dependency caching.
      # Required for building the frontend (Vite build) before Tauri packaging.
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      # Step 3: Set up Rust stable toolchain with the target platform.
      # The 'targets' input installs the cross-compilation target triple.
      # For macOS (aarch64) and Windows (x86_64-msvc), this ensures the correct
      # standard library is available. Linux uses the default host target.
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.settings.rust_target }}

      # Step 4: Cache Rust compilation artifacts.
      # Release builds compile all dependencies from scratch with optimizations,
      # which takes 15-30 minutes without caching. The cache saves most of this time.
      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      # Step 5: Install Linux system dependencies for native x64 builds.
      # Same dependencies as ci.yml -- required for compiling the Rust backend
      # which links against WebKit, GTK, and other native libraries.
      # Only runs for the native Linux x64 build (not ARM cross-compilation).
      # @see https://v2.tauri.app/start/prerequisites/#linux
      - name: Install Linux dependencies
        if: runner.os == 'Linux' && matrix.settings.cross_arch == ''
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libssl-dev \
            libgtk-3-dev

      # Step 6: Set up Linux ARM cross-compilation environment.
      # This step configures multi-arch apt, installs ARM system libraries,
      # and sets up the cross-compilation toolchain. Only runs for ARM targets.
      #
      # The approach:
      #   1. Add the ARM architecture to dpkg (arm64 or armhf)
      #   2. Add Ubuntu ARM ports repository for ARM packages
      #   3. Pin x86_64 packages to the default repo to avoid conflicts
      #   4. Install the cross-compiler (gcc-aarch64-linux-gnu or gcc-arm-linux-gnueabihf)
      #   5. Install ARM versions of Tauri's system dependencies (webkit2gtk, gtk3, etc.)
      - name: Setup Linux ARM cross-compilation
        if: matrix.settings.cross_arch != ''
        env:
          CROSS_ARCH: ${{ matrix.settings.cross_arch }}
          CROSS_GCC: ${{ matrix.settings.cross_gcc }}
        run: |
          # Add the ARM architecture so apt can install ARM packages
          sudo dpkg --add-architecture $CROSS_ARCH

          # Restrict the default Ubuntu sources to amd64 only.
          # Ubuntu 24.04 uses deb822 format in /etc/apt/sources.list.d/ubuntu.sources.
          # Without this, apt-get update tries to fetch ARM packages from
          # security.ubuntu.com and archive.ubuntu.com, which don't host ARM
          # packages and return 404. ARM packages must come from ports.ubuntu.com.
          if [ -f /etc/apt/sources.list.d/ubuntu.sources ]; then
            sudo sed -i 's/^Types: deb$/Architectures: amd64\nTypes: deb/' /etc/apt/sources.list.d/ubuntu.sources
          fi
          # Also handle legacy sources.list format (Ubuntu < 24.04)
          if [ -f /etc/apt/sources.list ]; then
            sudo sed -i 's|^deb http|deb [arch=amd64] http|g' /etc/apt/sources.list
          fi

          # Add Ubuntu ports repository for ARM packages.
          # The standard archive only has amd64/i386; ARM packages come from ports.
          CODENAME=$(lsb_release -cs)
          sudo tee /etc/apt/sources.list.d/arm-cross.list << EOF
          deb [arch=$CROSS_ARCH] http://ports.ubuntu.com/ubuntu-ports/ $CODENAME main restricted universe
          deb [arch=$CROSS_ARCH] http://ports.ubuntu.com/ubuntu-ports/ $CODENAME-updates main restricted universe
          deb [arch=$CROSS_ARCH] http://ports.ubuntu.com/ubuntu-ports/ $CODENAME-security main restricted universe
          EOF

          sudo apt-get update

          # Install the cross-compilation toolchain
          sudo apt-get install -y $CROSS_GCC

          # Install ARM versions of Tauri's native library dependencies.
          # The :$CROSS_ARCH suffix tells apt to install the ARM variant.
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev:$CROSS_ARCH \
            libappindicator3-dev:$CROSS_ARCH \
            librsvg2-dev:$CROSS_ARCH \
            patchelf \
            libssl-dev:$CROSS_ARCH \
            libgtk-3-dev:$CROSS_ARCH

      # Step 7: Configure cross-compilation environment variables.
      # These environment variables tell Cargo and pkg-config how to find
      # the ARM libraries and which linker to use for the target architecture.
      - name: Configure cross-compilation env
        if: matrix.settings.cross_arch != ''
        run: |
          # Tell Cargo which linker to use for the target triple.
          # The env var name is CARGO_TARGET_<TRIPLE>_LINKER with dashes replaced by underscores.
          TARGET_UPPER=$(echo "${{ matrix.settings.rust_target }}" | tr '[:lower:]-' '[:upper:]_')
          echo "CARGO_TARGET_${TARGET_UPPER}_LINKER=${{ matrix.settings.cross_linker }}" >> "$GITHUB_ENV"

          # Configure pkg-config to find ARM libraries instead of host x86_64 ones.
          echo "PKG_CONFIG_PATH=/usr/lib/${{ matrix.settings.cross_pkg_config_prefix }}/pkgconfig" >> "$GITHUB_ENV"
          echo "PKG_CONFIG_SYSROOT_DIR=/" >> "$GITHUB_ENV"
          echo "PKG_CONFIG_ALLOW_CROSS=1" >> "$GITHUB_ENV"

      # Step 8: Install npm dependencies.
      # 'npm ci' ensures a clean, reproducible install from package-lock.json.
      - name: Install npm dependencies
        run: npm ci

      # Step 9: Build the application and create release bundles.
      # The tauri-apps/tauri-action@v0 performs the complete build pipeline:
      #
      #   1. Frontend: Runs 'npm run build' (Vite production build)
      #   2. Backend:  Runs 'cargo build --release' with the target from matrix.settings.args
      #   3. Bundle:   Creates platform installers per tauri.conf.json "bundle" settings
      #   4. Release:  Creates/updates a GitHub Release and uploads installer files
      #
      # Environment:
      #   GITHUB_TOKEN -- Authenticates with GitHub API for release creation and asset upload.
      #                   This is the automatic token provided by GitHub Actions.
      #
      # Inputs:
      #   tagName     -- The Git tag that triggered this build (e.g., "v0.1.0")
      #   releaseName -- Human-readable release title shown on GitHub
      #   releaseBody -- Markdown content for the release description
      #   releaseDraft -- true = creates a draft release (not public until manually published)
      #   prerelease  -- false = marks this as a stable release (not pre-release)
      #   args        -- Extra arguments passed to 'cargo tauri build' (e.g., --target)
      #
      # @see https://github.com/tauri-apps/tauri-action -- Action documentation
      - name: Build and publish
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ steps.tag.outputs.name }}
          releaseName: 'MeedyaDL ${{ steps.tag.outputs.name }}'
          releaseBody: |
            ## MeedyaDL ${{ steps.tag.outputs.name }}

            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details.

            ### Downloads
            | Platform | Architecture | File |
            |----------|-------------|------|
            | macOS | Apple Silicon (ARM64) | `.dmg` |
            | Windows | x64 (64-bit) | `.exe` |
            | Windows | ARM64 (Snapdragon X) | `.exe` |
            | Linux | x64 (64-bit) | `.deb` / `.AppImage` |
            | Linux | ARM64 (Pi 4/5, 64-bit) | `.deb` *(experimental)* |
            | Linux | ARMv7 (Pi, 32-bit) | `.deb` *(experimental)* |

            > **Windows ARM64 users**: The x64 installer also works on ARM64 via Windows' built-in emulation.

            ### macOS Users
            macOS may show **"MeedyaDL is damaged and can't be opened"** because the app
            is not code-signed with an Apple Developer certificate. To fix this, run
            the following command in Terminal after downloading:

            ```
            xattr -cr /Applications/MeedyaDL.app
            ```

            Then open the app normally.

            ### First-Time Users
            On first launch, the app will download Python and GAMDL automatically.
            You will also need Apple Music cookies exported from your browser.
          releaseDraft: true
          prerelease: false
          args: ${{ matrix.settings.args }}
